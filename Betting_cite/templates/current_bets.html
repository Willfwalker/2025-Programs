{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Current Betting Lines</h2>
    
    {% if current_user.is_authenticated %}
    <div class="card mb-3">
        <div class="card-body">
            <h5>Your Balance: ${{ "%.2f"|format(current_user.balance) }}</h5>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h5>Create New Betting Line</h5>
            <form method="POST" action="{{ url_for('create_betting_line') }}">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="form-control" name="description" required>
                </div>
                <div class="form-group">
                    <label>Over/Under Value</label>
                    <input type="number" step="0.1" class="form-control" name="value" required>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Create Line</button>
            </form>
        </div>
    </div>

    <div class="betting-lines">
        {% for line in betting_lines %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ line.description }}</h5>
                <p class="card-text">Over/Under: {{ line.over_under_value }}</p>
                
                {% if line.is_active %}
                {% if current_user.id == line.created_by %}
                <button class="btn btn-danger mb-3 close-line-btn" data-line-id="{{ line.id }}">Close Betting Line</button>
                <div class="modal fade" id="closeModal-{{ line.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Close Betting Line</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>What was the result?</p>
                                <select class="form-control" id="result-{{ line.id }}">
                                    <option value="over">Over</option>
                                    <option value="under">Under</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary confirm-close" data-line-id="{{ line.id }}">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <form method="POST" action="{{ url_for('place_bet', line_id=line.id) }}">
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" step="0.01" class="form-control" name="amount" required>
                    </div>
                    <div class="form-group">
                        <select name="prediction" class="form-control mt-2" required>
                            <option value="over">Over</option>
                            <option value="under">Under</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success mt-2">Place Bet</button>
                </form>
                {% else %}
                <div class="alert alert-info">This betting line is closed</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-warning">
        Please <a href="{{ url_for('login') }}">login</a> to place bets.
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.close-line-btn').forEach(button => {
    button.addEventListener('click', function() {
        const lineId = this.getAttribute('data-line-id');
        const modal = new bootstrap.Modal(document.getElementById(`closeModal-${lineId}`));
        modal.show();
    });
});

document.querySelectorAll('.confirm-close').forEach(button => {
    button.addEventListener('click', async function() {
        const lineId = this.getAttribute('data-line-id');
        const result = document.getElementById(`result-${lineId}`).value;
        
        try {
            const response = await fetch(`/api/close_betting_line/${lineId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ result: result })
            });
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to close betting line');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to close betting line');
        }
    });
});
</script>

{% endblock %}
